---
title: 'Lab Six: Covariance and Correlation'
author:
 - Alex Davis
 - Cody Adams
output: pdf_document
---

Research is not always interested in the contrast of two variables, but oftentimes the relationship of two variables. For instance, what is the relationship between climate science and ideology? The following packages are required for this lab: 

1. ggplot2
2. psych
3. car
4. vcd
5. grid
6. gridExtra
7. dplyr

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
ds <- read.csv("https://github.com/ripberjt/qrmlabs/raw/master/Class%20Data%20Set%20Factored.csv")
library(ggplot2)
library(psych)
library(car)
library(vcd)
library(grid)
library(gridExtra)
library(dplyr)
options(scipen = 999)
```

## Part I: Covariance

Covariance is the measure of change in one variable associated to change in another variable. That is, the measure of how two random variables vary together.

Calculating covariance of two variables of a known population is trivial, as the product of variation of two variables. However, for samples, covariance is calculated via the following formula:

$$cov(x,y)=\frac{\sum_{i=1}^n (x_{i}-\bar{x})(y_{i}-\bar{y})}{{n-1}}$$

Where _x_ and _y_ are two random variables, _i_ is each observation (row), and _n_ is the sample size.

### Covariance by Hand 

To find covariance by hand, let's construct a hypothetical data set with variables x and y. We only give each variable three values so that the calculation will be shorter:

```{r cov, echo=TRUE}
x <- c(25, 27, 29)
y <- c(5, 15, 9)
```

First we calculate the difference of each value and the mean for the variables:

```{r cov2, echo=TRUE}
xdev <- x - mean(x)
ydev <- y - mean(y)
```

Next we find the product of the above differences:

```{r cov3, echo=TRUE}
xdev_ydev <- xdev * ydev
xdev_ydev
```

We complete the numerator by finding the sum of the products:

```{r cov4, echo=TRUE}
sum_xdev_ydev <- sum(xdev_ydev)
```

Lastly, we complete the covariance calculation by dividing the numerator by the denominator. The denominator is calculated as one less than the sample size:

```{r cov5, echo=TRUE}
cov_xy <- sum_xdev_ydev / (3 - 1)
cov_xy
```

### Covariance in R

By using the _cov()_ function, R calculates the covariance. We demonstrate the _cov()_ function by confirming the previous section's calculations:

```{r cov6, echo=TRUE}
cov(x, y)
```

### Covariance in Class Data Set

To demonstrate further we will calculate covariance for various pairs of variables within the class data set. First, suppose we are interested in the relationship between certainty that humans cause climate change (_glbcc_cert_) and the perceived risk of climate change (_glbcc_risk_). That is, is there a relationship between respondents' certainty that humans cause climate change and their perceived risk of climate change? Our hypothesis could be that individuals that are more certain that climate change is a consequence of humans are likely more concerned about the associated risk. 

```{r cov7, echo=TRUE}
cov(ds$glbcc_cert, ds$glbcc_risk, use = "complete.obs")
```

__Note:__ The _cov()_ function requires _use="complete.obs"_ to remove NA entries.

The calculated covariance of certainty and risk perception is positive, indicating the two variables are positively related. As one variable changes, the other variable will change in the same direction with a magnitude of 3.09. Increased certainty that humans cause climate change increases the perceived risk of climate change.

Suppose we are also interested in the relationship of income and perceived risk of climate change:

```{r cov8, echo=TRUE}
cov(ds$income, ds$glbcc_risk, use = "complete.obs")
```

The calculated covariance of income and perceived risk of climate change is negative, indicating the two variables are negatively related. As one variable changes, the other variable will change in the opposite direction with a magnitude of -10826.91.

An important follow-up question is: which variable is more strongly associated to perceived risk, certainty or income? We cannot compare magnitudes to the difference in scales and units. Income is measured on a scale inclusive of higher numbers compared to certainty. To compare strengths of association we need to standardize covariance.

## Part II: Correlation

Correlation standardizes covariance on a scale of negative one to one, whereby the magnitude from zero indicates strength of relationship. Similar to covariance, a positive and negative value reflects the respective relationship. The formula for correlation is the following:

$$r_{xy}=\frac{cov(x,y)}{s_xs_y}$$
  
Where x and y are two random variables.

### Correlation by Hand

To find covariance by hand, let's use the data set we constructed earlier to calculate covariance.

Recall we calculated covariance manually via the following steps:

```{r cor, echo=TRUE}
x <- c(25, 27, 29)
y <- c(5, 15, 9)
xdev <- x - mean(x)
ydev <- y - mean(y)
xdev_ydev <- xdev * ydev
sum_xdev_ydev <- sum(xdev_ydev)
cov_xy <- (1 / (3 - 1)) * sum_xdev_ydev
cov_xy
```

For calculating correlation we need the product of the standard deviations of variables _x_ and _y_ for the denominator:

```{r cor2, echo=TRUE}
stnd.dev <- sd(x)*sd(y)
```

Now we find the quotient of the covariance numerator and standard deviations denominator:

```{r cor3, echo=TRUE}
cov_xy/stnd.dev
```

The relationship is positive; however, the correlation coefficient is $\approx$ 0.40. 

Returning to the class data set, we can find the correlation coefficient for certainty humans cause climate change and perceived risk of climate change from the class data set:

```{r cor4, echo=TRUE}
numerator <- cov(ds$glbcc_cert, ds$glbcc_risk, use = "complete.obs")
denominator <- sd(ds$glbcc_cert, na.rm = T) * sd(ds$glbcc_risk, na.rm = T)
numerator / denominator
```

The correlation coefficient is $\approx$ 0.37.

Now let's find the correlation coefficient for ideology and perceived risk from climate change.

First we will create a subset from the class data set _ds_ for the variables of interest, absent of missing observations. __Note:__ This subset includes additional variables, _f.gender_ and _f.party.2_ for use later in this lab.

```{r cor5, echo=TRUE}
ds.sub <- filter(ds) %>% select("glbcc_risk", "ideol", "f.gender", "f.party.2") %>% na.omit()
```

The perceived risk and ideology variables are assigned to _x_ and _y_ variables within the _ds.sub_ object, as to follow the formula.

```{r cor6, echo=TRUE}
ds.sub$x <- ds.sub$glbcc_risk
ds.sub$y <- ds.sub$ideol
```

The _x_ and _y_ variables are then used to find the covariance, similar to the steps demonstrated earlier:

```{r cor7, echo=TRUE}
xbar <- mean(ds.sub$x)
ybar <- mean(ds.sub$y)

x.m.xbar <- ds.sub$x - xbar
y.m.ybar <- ds.sub$y - ybar

n <- length(ds.sub$x)
n

cov.xy <- (sum(x.m.xbar * y.m.ybar)) / (n - 1)
cov.xy
```

Next, we find the correlation coefficient using the covariance as the numerator and the product of both variable standard deviations as the denominator: 

```{r cor11, echo=TRUE}
sd.x <- sqrt((sum(x.m.xbar^2)) / (n - 1))
sd.x

sd.y <- sqrt((sum(y.m.ybar^2)) / (n - 1))
sd.y

sd.xy <- sd.x*sd.y

cov.xy/sd.xy
```

The correlation coefficient for the variables is $\approx$ -0.59. The manual calculation is confirmed using the _cor()_ function in R:

```{r cor15, echo=TRUE}
cor(ds.sub$glbcc_risk, ds.sub$ideol)
```

__Note:__ To calculate the correlation coefficient manually in one line of code:

_sum((x-mean(x))*(y-mean(y))) /(sqrt(sum((x-mean(x))^2))*sqrt(sum((y-mean(y))^2)))_

### Correlation Tests

The previous section demonstrated the _cor()_ function to confirm the manual calculation of the correlation coefficient. Using this function we can find the correlation coefficient of the income and perceived risk variables:

```{r cor16, echo=TRUE}
cor(ds$income, ds$glbcc_risk, use = "complete.obs")
```

The correlation coefficient of -0.06 informs us of two things: the relationship is negative and very weak. __Note:__ The correlation coefficient is drawn from observations within a sample, and therefore is a random value. That is, if we were to collect multiple samples we would calculate different correlation coefficients for each sample collected. This leads to a new hypothesis: is there a relationship between income and perceived risk? To test this we employ Pearson's product-moment correlation available via the _cor.test()_ function. Our testing hypotheses are:  

-$H_0$: the true correlation coefficient is zero  
-$H_1$: the true correlation coefficient is not zero

```{r cor.test, echo=TRUE}
cor.test(ds$income, ds$glbcc_risk, use="complete.obs")
```

The correlation test yields a p-value < $\alpha$ = 0.05, thereby the null hypothesis is rejected such that the true correlation coefficient is not zero. 

__Note:__ Despite rejecting the null hypothesis, our random correlation value is still quite small at -0.06. This indicates a very weak, or non-substance, relationship between income and perceived risk.

To demonstrate a potentially substantive relationship we look at ideology and perceived risk of climate change using the _cor.test()_ function:

```{r cor.test2, echo=TRUE}
cor.test(ds$ideol, ds$glbcc_risk)
```

The default correlation test method for the _cor.test()_ function is the Pearson test. The Spearman test is required for ordinal data via the _method="spearman"_ argument within the _cor.test()_ function. For calculation correlation with ordinal data.

### Correlation Across Groups

Suppose you are interested in correlations across multiple variables. The _cor()_ function examines the correlation between each variable pair for an entire data set. As such, if you are interested in only the correlation for select variables then creating a new data set object is applicable. To demonstrate using variables from the class data set:

```{r cor.group, echo=TRUE}
group <- data.frame(ds$glbcc_risk, ds$ideol, ds$income, ds$age)
```

The _group_ object is constructed from the _glbcc_risk_, _ideol_, _income_, and _age_ variables from the _ds_ data set. The _cor()_ function calculates the correlation coefficients for each variable pair individually

```{r cor.group2, echo=TRUE}
cor(group, use = "complete.obs")
```

This resulting matrix provides the correlation coefficients for two variables at a time. The correlation coefficients are defined by the intercept of the row and columns corresponding to each variable.

Additionally, recalling that each correlation coefficient itself is a random value, a test is required for inference. The _corr.test()_ provided by the _psych_ package is an alternative to the _cor.test()_ function previously used. The _corr.test()_ function supports examining variable pairs simultaneously within a given data set. Use the _print()_ function with the _short=FALSE_ argument to view the complete test with confidence intervals and p-values.

```{r cor.group3, echo=TRUE}
corr.test(group, use = "complete.obs") %>% print(short = FALSE)
```

## Part III: Visualizing Correlation

The simplest form to visualize correlation is a scatter plot with a trend line.

We will review the relationship between ideology and perceived risk from climate change. Build the basic visualization by using _ggplot()_ and the _geom_point_ functions, with ideology on the x axis and perceived risk about climate change on the y axis. Use the _ds.sub_ dataset, because we removed the missing values. 

```{r vis, echo=TRUE}
ggplot(ds.sub, aes(x = ideol, y = glbcc_risk)) +
  geom_point(shape = 1)
```

Notice how this doesn't really make sense? This is because there are thousands of observations being placed on a discrete set of values. To get a better idea of the relationship, we can tell R to jitter the points. This provides a better picture of the relationship. This time use the *geom_jitter* function instead of the *geom_point* function:

```{r vis2, echo=TRUE}
ggplot(ds.sub, aes(x = ideol, y = glbcc_risk)) +
  geom_jitter(shape = 1)
```

Notice the apparent negative correlation. Verify this by checking the correlation:

```{r vis3, echo=TRUE}
cor(ds.sub$ideol, ds.sub$glbcc_risk, use = "complete.obs")
```

A trend line to the scatter plot helps to interpret directionality of a given variable pair. The next lab will further introduce trend lines, but for now we introduce it via the *geom_smooth()* function by including the _method=lm_ argument. We also need to include *geom_point()* for each point.

```{r vis4, echo=TRUE}
ggplot(ds.sub, aes(x = ideol, y = glbcc_risk)) +
  geom_point(shape = 1) +
  geom_smooth(method = lm) +
  geom_jitter(shape = 1)
```

The ideology points can be differentiated by other variables, such as gender, to examine potential difference among gender by defining the _color_ argument as follows:

```{r vis5, echo=TRUE}
ggplot(ds.sub, aes(x = ideol, y = glbcc_risk, color = f.gender)) +
  geom_point(shape = 1) +
  geom_smooth(method = lm) +
  geom_jitter(shape = 1)
```

### Another Example: Political Party

Let's look at this relationship broken down by political party. Perhaps you wanted to see if the relationship looks different for Republicans and Democrats. We can first subset the data for Republicans and Democrats:

```{r part, echo=TRUE}
ds.dem <- filter(ds.sub, f.party.2 == "Dem")
ds.rep <- filter(ds.sub, f.party.2 == "Rep")
```

Next we investigate the correlation between ideology and perceived risk of climate change for Republicans and Democrats separately:

```{r part2, echo=TRUE}
cor.test(ds.rep$ideol, ds.rep$glbcc_risk)
cor.test(ds.dem$ideol, ds.dem$glbcc_risk)
```

The correlation coefficient is slightly more negative for Democrats.

To visualize: first create the scatter plot and trend lines for each party subset separately and for both combined. Assign each plot to an object. Then using the _grid.arrange()_ function, plot each of them:

```{r part3, echo=TRUE}
rep <- ggplot(ds.rep, aes(x = ideol, y = glbcc_risk)) +
  geom_point(shape = 1) +
  geom_smooth(method = lm) +
  geom_jitter(shape = 1)

dem <- ggplot(ds.dem, aes(x = ideol, y = glbcc_risk)) +
  geom_point(shape = 1) +
  geom_smooth(method = lm) +
  geom_jitter(shape = 1)

party <- ggplot(ds.sub, aes(x = ideol, y = glbcc_risk, color = f.party.2)) +
  geom_point(shape = 1) +
  geom_smooth(method = lm) +
  geom_jitter(shape = 1)

grid.arrange(party, rep, dem)
```

There does not appear to be a big difference in the relationship.

### One More Visualization

We cap this lab off with creating one last visualization. First create a new subset of our data exclusive of all missing observations. Include variables for climate change risk and age. 

```{r 2vis, echo=TRUE}
sub.ds <- filter(ds) %>% select("glbcc_risk", "age") %>% na.omit()
```

First we look at our age variable.

```{r 2vis2, echo=TRUE}
describe(sub.ds$age)
```

Now find the correlation:

```{r 2vis3, echo=TRUE}
cor.test(sub.ds$glbcc_risk, sub.ds$age)
```

There is a slight negative correlation. We can interpret this as indicating that younger people are slightly more concerned about climate change. Now we construct the visualization:

```{r 2vis4, echo=TRUE}
ggplot(sub.ds, aes(y = glbcc_risk, x = age)) +
  geom_point(shape = 20, color = "#e20000") +
  geom_jitter(shape = 20, color = "#e20000") +
  geom_smooth(method = lm) +
  xlab("Age") +
  ylab("Climate Change Risk") +
  ggtitle("Age and Climate Change Risk") +
  scale_y_continuous(breaks = c(0:10),
                     labels = c("0","1","2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  theme_bw()
```
